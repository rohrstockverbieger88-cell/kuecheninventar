<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K√ºchen-Chef Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #f1f5f9; --card: #ffffff; --primary: #4f46e5; --text: #1e293b;
            --danger: #ef4444; --secondary: #64748b; --accent: #10b981;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif;
            background-color: #222; display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw; overflow: hidden;
        }
        #app-container {
            width: 100%; height: 100%; background: var(--bg); position: relative;
            display: flex; flex-direction: column; overflow: hidden;
        }
        header { 
            padding: 1.5vh 4vw; background: white; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--primary); font-weight: 800; }
        .burger-menu { cursor: pointer; padding: 10px; }
        .burger-bar { width: 25px; height: 3px; background: var(--primary); margin: 4px 0; }
        #menu-dropdown {
            position: absolute; top: 60px; right: 10px; background: white; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; flex-direction: column;
            z-index: 5000; border: 1px solid #e2e8f0;
        }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .main-content { flex: 1; padding: 12px; overflow: hidden; display: flex; flex-direction: column; gap: 10px; }
        .tile {
            background: white; border-radius: 16px; padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; min-height: 0;
        }
        .tile h2 { margin: 0 0 8px 0; font-size: 0.8rem; color: var(--secondary); text-transform: uppercase; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        .scroll-area { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        .item-info-btn { flex: 1; background: none; border: none; text-align: left; padding: 12px 5px; display: flex; flex-direction: column; font-family: inherit; }
        .controls { display: flex; gap: 15px; align-items: center; }
        .controls button { width: 55px; height: 45px; border: none; background: #f1f5f9; border-radius: 10px; font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .bottom-bar { padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; gap: 10px; flex-shrink: 0; }
        .btn-nav { flex: 1; padding: 16px; border-radius: 15px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-shopping { background: var(--accent); color: white; }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); transform: translateX(100%); transition: transform 0.25s ease-out; z-index: 4000; display: flex; flex-direction: column; }
        .page.active { transform: translateX(0); }
        .page-header { padding: 15px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .page-body { flex: 1; overflow-y: auto; padding: 15px; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 1rem; margin-bottom: 10px; width: 100%; }
        label { font-weight: bold; font-size: 0.9rem; color: var(--secondary); display: block; margin-top: 10px; }
        #shop-suggestions { background: white; border: 1px solid #ddd; border-radius: 10px; margin-top: -10px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .shopping-row { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .shop-check { width: 35px; height: 35px; accent-color: var(--accent); }
        .finish-bar { padding: 15px; background: #fff; border-top: 2px solid var(--accent); display: flex; flex-direction: column; gap: 10px; }
        .btn-danger { background: #fee2e2; color: var(--danger); border: none; border-radius: 10px; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <h1>K√úCHEN-CHEF CLOUD</h1>
        <div class="burger-menu" onclick="toggleMenu()"><div class="burger-bar"></div><div class="burger-bar"></div><div class="burger-bar"></div></div>
    </header>

    <div id="menu-dropdown">
        <div class="menu-item" onclick="exportCSV()">üì§ CSV Export</div>
        <div class="menu-item" onclick="document.getElementById('csvImport').click()">üì• CSV Import</div>
    </div>
    <input type="file" id="csvImport" style="display:none" accept=".csv" onchange="importCSV(event)">

    <div class="main-content">
        <div class="tile" style="flex: 2;"><h2>‚≠ê FAVORITEN</h2><div id="fav-list" class="scroll-area"></div></div>
        <div class="tile" style="flex: 2;"><h2>üïí ZULETZT ENTNOMMEN</h2><div id="recent-list" class="scroll-area"></div></div>
        <div id="warn-tile" class="tile" style="display:none; border-left: 8px solid var(--danger); flex: 1.2;">
            <h2 style="color:var(--danger);">‚ö†Ô∏è BESTAND KNAPP</h2><div id="warn-list" class="scroll-area"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn-nav btn-shopping" onclick="openShoppingList()">üõí EINKAUFSLISTE</button>
        <button class="btn-nav btn-primary" onclick="openPage('inventory-page')">üì¶ ABLEGEN</button>
    </div>

    <div id="shopping-page" class="page">
        <div class="page-header"><h2>Einkaufsliste</h2><button onclick="closePage('shopping-page')">Zur√ºck</button></div>
        <div class="page-body">
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="text" id="manual-shop-name" placeholder="Suchen oder Neu..." onkeyup="showShopSuggestions(this.value)">
                <button style="background: var(--accent); color: white; border: none; border-radius: 10px; padding: 0 20px; font-weight: bold; font-size: 1.5rem;" onclick="prepareShoppingAdd()">+</button>
            </div>
            <div id="shop-suggestions"></div><div id="shopping-items-container"></div>
        </div>
        <div class="finish-bar">
            <button class="btn-nav btn-shopping" onclick="finishShopping()">‚úÖ EINKAUF BEENDEN</button>
            <button class="btn-danger" onclick="clearShoppingList()">Liste leeren</button>
        </div>
    </div>

    <div id="add-page" class="page">
        <div class="page-header"><h2 id="add-title">Neu anlegen</h2><button onclick="cancelAdd()">‚úï</button></div>
        <div class="page-body">
            <input type="hidden" id="edit-id"><input type="hidden" id="context-mode" value="inventory">
            <label>Name</label><input type="text" id="add-name">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Menge</label><input type="number" id="add-qty" value="1"></div>
                <div style="flex:1"><label>Einheit</label>
                    <select id="add-unit"><option value="St">St</option><option value="kg">kg</option><option value="g">g</option><option value="ml">ml</option><option value="l">l</option></select>
                </div>
            </div>
            <label style="display:flex; align-items:center; gap:15px; margin: 15px 0;"><input type="checkbox" id="add-is-fav" style="width:25px; height:25px;"> ‚≠ê Favorit</label>
            <label style="display:flex; align-items:center; gap:15px;"><input type="checkbox" id="add-has-limit" onchange="document.getElementById('limit-box').style.display = this.checked ? 'block' : 'none'" style="width:25px; height:25px;"> ‚ö†Ô∏è Melden wenn knapp</label>
            <div id="limit-box" style="display:none; margin-top:15px;"><label>Warnung bei Menge <=</label><input type="number" id="add-limit-val"></div>
            <button style="background:var(--primary); color:white; width:100%; padding:20px; border-radius:15px; border:none; margin-top:30px; font-weight:bold; font-size:1.2rem;" onclick="saveItem()">SPEICHERN</button>
        </div>
    </div>

    <div id="inventory-page" class="page">
        <div class="page-header"><h2>Ablage</h2><button onclick="closePage('inventory-page')">Zur√ºck</button></div>
        <div class="page-body">
            <button class="btn-nav btn-primary" style="width:100%; margin-bottom:15px;" onclick="prepareAdd()">+ Lebensmittel anlegen</button>
            <button class="btn-nav btn-shopping" style="width:100%; margin-bottom:15px;" onclick="openPage('search-page')">üîç Suchen</button>
            <button class="btn-nav btn-primary" style="width:100%; background:var(--secondary)" onclick="openPage('all-list-page')">üìã Alle (A-Z)</button>
        </div>
    </div>
    <div id="search-page" class="page">
        <div class="page-header"><h2>Suche</h2><button onclick="closePage('search-page')">Zur√ºck</button></div>
        <div class="page-body"><input type="text" id="live-search-input" onkeyup="doLiveSearch()"><div id="live-search-results"></div></div>
    </div>
    <div id="all-list-page" class="page">
        <div class="page-header"><h2>Gesamtliste</h2><button onclick="closePage('all-list-page')">Schlie√üen</button></div>
        <div id="all-items-container" class="page-body"></div>
    </div>
</div>

<script>
    // --- DEINE FIREBASE KONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAOemsGYyQJQl4XgQd_IL2XookAdfkbtk0",
        authDomain: "kuecheninventa.firebaseapp.com",
        projectId: "kuecheninventa",
        storageBucket: "kuecheninventa.firebasestorage.app",
        messagingSenderId: "45795620924",
        appId: "1:45795620924:web:f0f56e5513108b0ef0eb39",
        databaseURL: "https://kuecheninventa-default-rtdb.europe-west1.firebasedatabase.app"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let items = [];
    let shoppingList = [];
    let recentIds = [];
    const units = ["St", "kg", "g", "ml", "l"];

    // CLOUD SYNC
    function sync() {
        items.sort((a, b) => a.name.localeCompare(b.name, 'de', {sensitivity: 'base'}));
        db.ref('kitchen_data').set({
            items: items,
            shoppingList: shoppingList,
            recentIds: recentIds
        });
    }

    // ECHTZEIT LISTENER
    db.ref('kitchen_data').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            items = data.items || [];
            shoppingList = data.shoppingList || [];
            recentIds = data.recentIds || [];
            renderHome();
            renderAll();
            renderShopping();
        }
    });

    // NAVIGATION
    function toggleMenu() { const m = document.getElementById('menu-dropdown'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function openPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.getElementById('menu-dropdown').style.display = 'none'; }
    function closePage(id) { document.getElementById(id).classList.remove('active'); }

    // LOGIK
    function prepareAdd() {
        document.getElementById('edit-id').value = "";
        document.getElementById('context-mode').value = "inventory";
        document.getElementById('add-name').value = "";
        document.getElementById('add-qty').value = "1";
        document.getElementById('add-is-fav').checked = false;
        document.getElementById('add-has-limit').checked = false;
        document.getElementById('limit-box').style.display = 'none';
        document.getElementById('add-title').innerText = "Neu anlegen";
        openPage('add-page');
    }

    function prepareShoppingAdd() {
        const name = document.getElementById('manual-shop-name').value.trim();
        if(!name) return;
        prepareAdd();
        document.getElementById('add-name').value = name;
        document.getElementById('context-mode').value = "shopping";
        document.getElementById('add-title').innerText = "Einkauf planen";
    }

    function saveItem() {
        const id = document.getElementById('edit-id').value;
        const mode = document.getElementById('context-mode').value;
        const name = document.getElementById('add-name').value.trim();
        const qty = parseFloat(document.getElementById('add-qty').value) || 0;
        const unit = document.getElementById('add-unit').value;
        const fav = document.getElementById('add-is-fav').checked;
        const hasLimit = document.getElementById('add-has-limit').checked;
        const limitVal = hasLimit ? (parseFloat(document.getElementById('add-limit-val').value) || 0) : null;
        if (!name) return;
        if (mode === "shopping") {
            shoppingList.push({ name, qty, unit, fav, limit: limitVal, bought: false });
            document.getElementById('manual-shop-name').value = '';
            sync(); openPage('shopping-page');
        } else {
            if (id) {
                const idx = items.findIndex(i => i.id == id);
                if(idx !== -1) items[idx] = { ...items[idx], name, qty, unit, fav, limit: limitVal };
            } else {
                items.push({ id: Date.now(), name, qty, unit, fav, limit: limitVal });
            }
            sync(); closePage('add-page');
        }
    }

    function updateQty(id, delta) {
        const item = items.find(i => i.id == id);
        if(item) {
            item.qty = Math.max(0, item.qty + delta);
            if(delta < 0) recentIds = [parseInt(id), ...recentIds.filter(rid => rid != id)].slice(0, 5);
            sync();
        }
    }

    function finishShopping() {
        const boughtItems = shoppingList.filter(s => s.bought);
        if (boughtItems.length === 0) return alert("Nichts abgehakt!");
        if (confirm("Bestand aktualisieren?")) {
            boughtItems.forEach(bought => {
                const existing = items.find(i => i.name.toLowerCase() === bought.name.toLowerCase());
                if (existing) { existing.qty += bought.qty; existing.fav = bought.fav; existing.limit = bought.limit; } 
                else { items.push({ id: Date.now() + Math.random(), name: bought.name, qty: bought.qty, unit: bought.unit, fav: bought.fav, limit: bought.limit }); }
            });
            shoppingList = shoppingList.filter(s => !s.bought);
            sync(); closePage('shopping-page');
        }
    }

    // RENDER
    function createRow(item, isAllList = false) {
        return `<div class="item-row">
            <button class="item-info-btn" onclick="openEdit('${item.id}')"><b>${item.name}</b><small>${item.qty} ${item.unit} ${item.fav ? '‚≠ê' : ''}</small></button>
            <div class="controls"><button onclick="updateQty('${item.id}', -1)">-</button><button onclick="updateQty('${item.id}', 1)">+</button>
            ${isAllList ? `<button class="btn-danger" style="margin-left:5px; height:45px; width:45px;" onclick="deleteItem('${item.id}')">‚úï</button>` : ''}</div></div>`;
    }

    function renderHome() {
        document.getElementById('fav-list').innerHTML = items.filter(i => i.fav).map(i => createRow(i)).join('') || 'Keine Favoriten.';
        const recentItems = recentIds.map(rid => items.find(i => i.id == rid)).filter(Boolean);
        document.getElementById('recent-list').innerHTML = recentItems.map(i => createRow(i)).join('') || 'Keine Aktivit√§t.';
        const warnings = items.filter(i => i.limit !== null && i.qty <= i.limit);
        const warnTile = document.getElementById('warn-tile');
        if(warnings.length > 0) {
            warnTile.style.display = 'flex';
            document.getElementById('warn-list').innerHTML = warnings.map(i => `<div>‚Ä¢ ${i.name} (${i.qty} ${i.unit})</div>`).join('');
        } else { warnTile.style.display = 'none'; }
    }

    function renderAll() { const c = document.getElementById('all-items-container'); if(c) c.innerHTML = items.map(i => createRow(i, true)).join(''); }

    function renderShopping() {
        const c = document.getElementById('shopping-items-container'); if(!c) return;
        c.innerHTML = shoppingList.map((item, index) => `
            <div class="shopping-row"><div style="display:flex; justify-content:space-between; align-items:center;"><b>${item.name}</b>
            <div style="display:flex; align-items:center; gap:20px;"><input type="checkbox" class="shop-check" ${item.bought ? 'checked' : ''} onchange="toggleBought(${index})">
            <button class="btn-danger" style="padding:8px" onclick="removeShopItem(${index})">üóëÔ∏è</button></div></div>
            <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:10px;">
            <button onclick="updateShopQty(${index}, -1)" style="width:55px; height:45px; border:none; border-radius:10px;">-</button>
            <span style="font-weight:bold; min-width:60px; text-align:center">${item.qty} ${item.unit}</span>
            <button onclick="updateShopQty(${index}, 1)" style="width:55px; height:45px; border:none; border-radius:10px;">+</button></div></div>`).join('') || '<p style="text-align:center;">Leer.</p>';
    }

    // HELPERS
    function openEdit(id) {
        const item = items.find(i => i.id == id); if(!item) return;
        document.getElementById('edit-id').value = item.id;
        document.getElementById('context-mode').value = "inventory";
        document.getElementById('add-name').value = item.name;
        document.getElementById('add-qty').value = item.qty;
        document.getElementById('add-unit').value = item.unit;
        document.getElementById('add-is-fav').checked = item.fav;
        document.getElementById('add-has-limit').checked = item.limit !== null;
        document.getElementById('add-limit-val').value = item.limit || "";
        document.getElementById('limit-box').style.display = item.limit !== null ? 'block' : 'none';
        document.getElementById('add-title').innerText = "Bearbeiten";
        openPage('add-page');
    }
    function toggleBought(idx) { shoppingList[idx].bought = !shoppingList[idx].bought; sync(); }
    function updateShopQty(index, delta) { shoppingList[index].qty = Math.max(1, shoppingList[index].qty + delta); sync(); }
    function removeShopItem(index) { shoppingList.splice(index, 1); sync(); }
    function clearShoppingList() { if(confirm("Leeren?")) { shoppingList = []; sync(); } }
    function deleteItem(id) { if(confirm('L√∂schen?')) { items = items.filter(x => x.id != id); sync(); } }
    function openShoppingList() {
        const lows = items.filter(i => i.limit !== null && i.qty <= i.limit);
        lows.forEach(low => { if(!shoppingList.find(s => s.name.toLowerCase() === low.name.toLowerCase())) { shoppingList.push({ name: low.name, qty: 1, unit: low.unit || "St", fav: low.fav, limit: low.limit, bought: false }); } });
        sync(); openPage('shopping-page');
    }
    function showShopSuggestions(val) {
        const s = document.getElementById('shop-suggestions'); if (!val) { s.style.display = 'none'; return; }
        const f = items.filter(i => i.name.toLowerCase().includes(val.toLowerCase()));
        if (f.length === 0) { s.style.display = 'none'; return; }
        s.innerHTML = f.map(i => `<div class="suggestion-item" onclick="addFromSuggestion('${i.name}', '${i.unit}', ${i.fav}, ${i.limit})">${i.name}</div>`).join('');
        s.style.display = 'block';
    }
    function addFromSuggestion(name, unit, fav, limit) {
        if(!shoppingList.find(s => s.name.toLowerCase() === name.toLowerCase())) { shoppingList.push({ name, qty: 1, unit, fav, limit, bought: false }); }
        document.getElementById('manual-shop-name').value = ''; document.getElementById('shop-suggestions').style.display = 'none'; sync();
    }
    function doLiveSearch() {
        const v = document.getElementById('live-search-input').value.toLowerCase().trim();
        const r = document.getElementById('live-search-results'); if(!v) { r.innerHTML = ''; return; }
        r.innerHTML = items.filter(i => i.name.toLowerCase().includes(v)).map(i => createRow(i)).join('');
    }
    function cancelAdd() { if(document.getElementById('context-mode').value === "shopping") openPage('shopping-page'); else closePage('add-page'); }
    function exportCSV() {
        let csv = "Name Lebensmittel;Bestand;Einheit;Favorit;Melden wenn knapp\n";
        items.forEach(i => csv += `${i.name};${i.qty};${i.unit};${i.fav ? 'JA' : 'NEIN'};${i.limit !== null ? i.limit : '-'}\n`);
        const BOM = '\uFEFF'; const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "inventar.csv"; link.click();
    }
    function importCSV(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split(/\r?\n/); const newItems = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cols = lines[i].split(/[;,]/);
                if (cols.length >= 5) newItems.push({ id: Date.now() + i, name: cols[0].trim(), qty: parseFloat(cols[1]) || 0, unit: cols[2].trim(), fav: cols[3].trim().toUpperCase() === 'JA', limit: cols[4].trim() === '-' ? null : parseFloat(cols[4]) });
            }
            if(confirm("Importieren?")) { items = newItems; sync(); }
        };
        reader.readAsText(event.target.files[0]);
    }
</script>
</body>
</html>
